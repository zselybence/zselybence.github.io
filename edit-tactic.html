<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R6 Taktika — Taktika szerkesztése</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    form {
      max-width: 600px;
      margin: 20px auto;
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .steps-container {
      margin-top: 12px;
    }
    .step-item {
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      position: relative;
    }
    .remove-step {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-weight: bold;
    }
    button.add-step {
      margin-top: 10px;
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    button.update-tactic {
      margin-top: 20px;
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1rem;
      width: 100%;
    }
    button.download-json {
      margin-top: 20px;
      background: #9b59b6;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1rem;
      width: 100%;
      margin-bottom: 20px;
      display: none;
    }
    .clear {
      clear: both;
    }
    pre#output {
      background: #f4f4f4;
      border: 1px solid #ccc;
      padding: 12px;
      margin-top: 20px;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    a.back-link {
      display: inline-block;
      margin: 20px auto;
      text-decoration: none;
      color: var(--accent);
      font-weight: bold;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <a href="manage-tactics.html" class="back-link">← Vissza a taktikák kezeléséhez</a>
  <form id="tacticForm">
    <h1>Taktika szerkesztése</h1>
    <label for="mapName">Térkép neve</label>
    <input type="text" id="mapName" name="mapName" required>

    <label for="siteName">Site neve</label>
    <input type="text" id="siteName" name="siteName" required>

    <label for="mode">Mód</label>
    <select id="mode" name="mode" required>
      <option value="attack">Támadás</option>
      <option value="defense">Védekezés</option>
    </select>

    <label for="tacticSelect">Taktika kiválasztása</label>
    <select id="tacticSelect" name="tacticSelect"></select>

    <label for="operator">Operátor neve (több operátor esetén, válaszd el őket vesszővel)</label>
    <input type="text" id="operator" name="operator" placeholder="Pl. Ash, Jäger">

    <label for="title">Taktika címe</label>
    <input type="text" id="title" name="title" placeholder="Pl. Gyors beugrás vagy Setup">

    <div class="steps-container" id="stepsContainer">
      <h2>Lépések</h2>
    </div>
    <button type="button" class="add-step" id="addStepBtn">+ Lépés hozzáadása</button>

    <button type="button" class="update-tactic" id="updateTacticBtn">Taktika frissítése</button>
    <div class="clear"></div>

    <pre id="output" aria-live="polite"></pre>
    <div id="saveStatus"></div>
    <button type="button" class="download-json" id="downloadJsonBtn" style="display: none;">JSON letöltése</button>
  </form>

  <script>
    const stepsContainer = document.getElementById('stepsContainer');
    const addStepBtn = document.getElementById('addStepBtn');
    const updateTacticBtn = document.getElementById('updateTacticBtn');
    const output = document.getElementById('output');
    const tacticSelect = document.getElementById('tacticSelect');

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const mapName = urlParams.get('map');
    const siteName = urlParams.get('site');
    const mode = urlParams.get('mode');

    // Pre-fill form with existing tactic data
    document.getElementById('mapName').value = mapName;
    document.getElementById('siteName').value = siteName;
    document.getElementById('mode').value = mode;

    let tacticsData = {};
    let currentTactic = {};

    // Load tactics data
    async function loadTacticsData() {
      try {
        const res = await fetch('data/tactics.json', { cache: 'no-cache' });
        tacticsData = await res.json();
        populateTacticSelect();
      } catch (error) {
        console.error('Error loading tactics data:', error);
      }
    }

    // Populate tactic select dropdown
    function populateTacticSelect() {
      tacticSelect.innerHTML = '';
      const mapObj = tacticsData.maps?.[mapName];
      const siteObj = mapObj?.sites?.[siteName];
      const tactics = siteObj?.[mode] || [];

      // Check if tactics is an array or an object
      if (Array.isArray(tactics)) {
        tactics.forEach((tactic, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = tactic.title || `Taktika ${index + 1}`;
          tacticSelect.appendChild(option);
        });
      } else if (tactics && typeof tactics === 'object') {
        // For defense mode, tactics might be an object
        const option = document.createElement('option');
        option.value = 0;
        option.textContent = tactics.title || 'Taktika';
        tacticSelect.appendChild(option);
      }

      // Select the first tactic by default if there are any tactics
      if (tacticSelect.options.length > 0) {
        tacticSelect.selectedIndex = 0;
        loadSelectedTactic();
      } else {
        // If no tactics, initialize with one step
        stepsContainer.innerHTML = '<h2>Lépések</h2>';
        addStepBtn.click();
      }
    }

    // Load selected tactic data
    function loadSelectedTactic() {
      const selectedIndex = tacticSelect.selectedIndex;
      if (selectedIndex < 0) return;

      const mapObj = tacticsData.maps?.[mapName];
      const siteObj = mapObj?.sites?.[siteName];
      const tactics = siteObj?.[mode] || [];

      if (Array.isArray(tactics)) {
        currentTactic = tactics[selectedIndex] || {};
      } else {
        currentTactic = tactics;
      }

      // Update form fields with selected tactic data
      document.getElementById('operator').value = Array.isArray(currentTactic.operator) ? currentTactic.operator.join(', ') : currentTactic.operator || '';
      document.getElementById('title').value = currentTactic.title || '';

      // Clear existing steps
      stepsContainer.innerHTML = '<h2>Lépések</h2>';

      // Add steps
      const steps = mode === 'attack' ? currentTactic.steps : currentTactic.setup;
      if (steps) {
        steps.forEach(step => {
          const stepItem = createStepItem();
          stepItem.querySelector('textarea').value = step.text;
          if (step.img) {
            stepItem.querySelector('input[type="number"]:nth-of-type(1)').value = step.img;
          }
          if (step.img2) {
            stepItem.querySelector('input[type="number"]:nth-of-type(2)').value = step.img2;
          }
          stepsContainer.appendChild(stepItem);
        });
      }

      // Initialize with one step if none exist
      if (stepsContainer.children.length === 1) {
        addStepBtn.click();
      }
    }

    // Event listener for tactic selection
    tacticSelect.addEventListener('change', loadSelectedTactic);

    function createStepItem() {
      const div = document.createElement('div');
      div.className = 'step-item';

      const textLabel = document.createElement('label');
      textLabel.textContent = 'Lépés szövege';
      const textInput = document.createElement('textarea');
      textInput.rows = 2;
      textInput.required = true;

      const imgLabel = document.createElement('label');
      imgLabel.textContent = 'Elsődleges kép száma (opcionális)';
      const imgInput = document.createElement('input');
      imgInput.type = 'number';
      imgInput.min = 1;
      imgInput.placeholder = 'Pl. 1';

      const imgLabel2 = document.createElement('label');
      imgLabel2.textContent = 'Másodlagos kép száma (opcionális)';
      const imgInput2 = document.createElement('input');
      imgInput2.type = 'number';
      imgInput2.min = 1;
      imgInput2.placeholder = 'Pl. 2';

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-step';
      removeBtn.textContent = '×';
      removeBtn.title = 'Lépés eltávolítása';
      removeBtn.addEventListener('click', () => {
        div.remove();
      });

      div.appendChild(removeBtn);
      div.appendChild(textLabel);
      div.appendChild(textInput);
      div.appendChild(imgLabel);
      div.appendChild(imgInput);
      div.appendChild(imgLabel2);
      div.appendChild(imgInput2);

      return div;
    }

    addStepBtn.addEventListener('click', () => {
      const stepItem = createStepItem();
      stepsContainer.appendChild(stepItem);
    });

    updateTacticBtn.addEventListener('click', () => {
      const mapName = document.getElementById('mapName').value.trim();
      const siteName = document.getElementById('siteName').value.trim();
      const mode = document.getElementById('mode').value;
      const operator = document.getElementById('operator').value.trim().split(',').map(op => op.trim()).filter(op => op); // Convert to array
      const title = document.getElementById('title').value.trim();

      if (!mapName || !siteName || !mode) {
        alert('Kérlek töltsd ki a kötelező mezőket: Térkép, Site, Mód.');
        return;
      }

      const steps = [];
      const stepItems = stepsContainer.querySelectorAll('.step-item');
      if (stepItems.length === 0) {
        alert('Adj hozzá legalább egy lépést.');
        return;
      }

      for (const item of stepItems) {
        const text = item.querySelector('textarea').value.trim();
        const imgVal = item.querySelector('input[type="number"]:nth-of-type(1)').value.trim();
        const imgVal2 = item.querySelector('input[type="number"]:nth-of-type(2)').value.trim();
        if (!text) {
          alert('Minden lépéshez adj meg szöveget.');
          return;
        }
        const stepObj = { text };
        if (imgVal) {
          stepObj.img = Number(imgVal);
        }
        if (imgVal2) {
          stepObj.img2 = Number(imgVal2);
        }
        steps.push(stepObj);
      }

      // Create the correct JSON structure with "maps" key
      const outputJson = {
        maps: {
          [mapName]: {
            sites: {
              [siteName]: {
                [mode]: mode === 'attack' ? [{
                  operator: operator || 'Any Operator',
                  title: title || '',
                  steps: steps
                }] : {
                  operator: operator || 'Any Operator',
                  title: title || '',
                  setup: steps
                }
              }
            }
          }
        }
      };

      output.textContent = JSON.stringify(outputJson, null, 2);
      downloadJsonBtn.style.display = 'block'; // Show download button
    });

    async function downloadCompleteTactics() {
      if (!output.textContent) {
        alert('Nincs letölthető adat.');
        return;
      }

      try {
        // Load existing tactics data
        const res = await fetch('data/tactics.json', { cache: 'no-cache' });
        const existingData = await res.json();
        
        // Parse the updated tactic data
        const updatedTacticData = JSON.parse(output.textContent);
        const updatedMapData = updatedTacticData.maps;
        const mapName = Object.keys(updatedMapData)[0];
        const mapData = updatedMapData[mapName];
        const siteName = Object.keys(mapData.sites)[0];
        const siteData = mapData.sites[siteName];
        const mode = Object.keys(siteData)[0];
        const tactic = siteData[mode];
        
        // Merge updated tactic with existing data
        const mergedData = JSON.parse(JSON.stringify(existingData)); // Deep copy
        
        // Initialize maps object if it doesn't exist
        if (!mergedData.maps) {
          mergedData.maps = {};
        }
        
        // Initialize map object if it doesn't exist
        if (!mergedData.maps[mapName]) {
          mergedData.maps[mapName] = { sites: {} };
        }
        
        // Initialize sites object if it doesn't exist
        if (!mergedData.maps[mapName].sites) {
          mergedData.maps[mapName].sites = {};
        }
        
        // Initialize site object if it doesn't exist
        if (!mergedData.maps[mapName].sites[siteName]) {
          mergedData.maps[mapName].sites[siteName] = {};
        }
        
        // Update the tactic
        mergedData.maps[mapName].sites[siteName][mode] = tactic;
        
        // Download the complete updated tactics.json
        const blob = new Blob([JSON.stringify(mergedData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tactics.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Error merging tactics data:', error);
        alert('Hiba történt a taktikák egyesítésekor.');
      }
    }

    downloadJsonBtn.addEventListener('click', () => {
      if (!output.textContent) {
        alert('Nincs letölthető adat.');
        return;
      }

      // Instead of downloading just the output, download the complete tactics.json
      downloadCompleteTactics();
    });

    // Initialize
    loadTacticsData();
  </script>
</body>
</html>
